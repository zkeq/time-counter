<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <link rel="stylesheet" href="/time-counter.css" />

    <title>README</title>
  </head>
  <body class="typora-export">
    <div class="typora-export-content">
      <div id="write" class="">
        <h2 id="网站在线人数统计"><span>网站在线人数统计</span></h2>
        <blockquote>
          <p align="center">
            <span
              >本项目是一个开箱即用的站点在线人数统计服务，同时开源支持私有化部署。</span
            >
          </p>
        </blockquote>
        <h3 id="前言"><span>前言：</span></h3>
        <ol start="">
          <li>
            <span>在维护一个 </span
            ><a href="https://tuostudy.com"><span>学习站点</span></a
            ><span>
              时，为了营造一种学习的氛围，开始猜想 能不能写一个实时在线人数 API
              呢？</span
            >
          </li>
          <li>
            <span
              >这是从 Plausible 站点中得到的一个思路，加以扩展 即 想法变成
              能否得到一个 </span
            ><code>记录每人在线时间</code><span> 的 API 呢？</span>
          </li>
          <li>
            <span
              >🤔 此项目的 代码/架构 实现完全由 @soxft
              开发，得到可以实现的肯定回答后，本项目上线于 2022.6.4
              并投入使用</span
            >
          </li>
          <li>
            <span
              >在 9 月份，因为开学等原因 数据库丢失 下线 3
              个月后，11月项目再次启动 稳定运行至今，处理 API 请求
              已达近数十亿次</span
            >
          </li>
          <li>
            <span
              >2023.2.5 元宵节，本项目由单个站点扩展为 Room
              机制，对外开放使用，同时开放源码支持独立部署：</span
            ><a href="https://github.com/soxft/time-counter"
              ><span>soxft/time-counter</span></a
            >
          </li>
        </ol>
        <h3 id="使用"><span>使用：</span></h3>
        <ol start="">
          <li>
            <span>选择一个独立的 </span><code>Room ID</code
            ><span> (10字符以内)</span>
          </li>
          <li>
            <span>选择 </span><code>Iframe</code><span> 方式使用 or </span
            ><code>js</code><span> 方式使用</span>
          </li>
          <li><span>Enjoy！</span></li>
        </ol>
        <details hide>
          <summary>Choice Room ID</summary>
        <h3 id="room-id"><span>Room ID：</span></h3>
        <p>
          <label for="room-input"><span>ROOMS:</span>&emsp;</label
          ><input type="text" id="room-input" />
        </p>
        <figure>
          <table>
            <thead>
              <tr>
                <th><span>Key</span></th>
                <th><span>Value</span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span>room ID</span></td>
                <td><span style="color: red" id="online_id"></span></td>
              </tr>
              <tr>
                <td><span>online user</span></td>
                <td><span style="color: red" id="online_user"></span></td>
              </tr>
              <tr>
                <td><span>my online time</span></td>
                <td><span style="color: red" id="online_me"></span></td>
              </tr>
              <tr>
                <td><span>total online time</span></td>
                <td><span style="color: red" id="online_total"></span></td>
              </tr>
            </tbody>
          </table>
        </figure>
      </details>

        <h3 id="用法"><span>用法：</span></h3>
        <ol start="">
          <li><span>Iframe 引入</span></li>
        </ol>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded"
          spellcheck="false"
          lang="html"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">center</span><span class="cm-tag cm-bracket">&gt;&lt;</span><span class="cm-tag">iframe</span> <span class="cm-attribute">frameborder</span>=<span class="cm-string">0</span> &nbsp;<span class="cm-attribute">height</span>=<span class="cm-string">50px</span> <span class="cm-attribute">marginwidth</span>=<span class="cm-string">0</span> <span class="cm-attribute">scrolling</span>=<span class="cm-string">no</span> <span class="cm-attribute">src</span>=<span class="cm-string">"https://time-counter.onmicrosoft.cn/room/{Room ID}"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">iframe</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">center</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre>
        <ol start="2">
          <li><span>JS 引入</span></li>
        </ol>
        <pre
          class="md-fences md-end-block ty-contain-cm modeLoaded md-focus"
          spellcheck="false"
          lang="html"
        ><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap CodeMirror-focused" lang="html"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 119px; left: 290px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span> <span class="cm-attribute">src</span>=<span class="cm-string">"https://time-counter.onmicrosoft.cn/counter.js"</span> <span class="cm-attribute">async</span>=<span class="cm-string">""</span> <span class="cm-attribute">id</span>=<span class="cm-string">"online-counter"</span> <span class="cm-attribute">interval</span>=<span class="cm-string">"0"</span> <span class="cm-attribute">api</span>=<span class="cm-string">"https://time-counter.onmicrosoft.cn/counter"</span> <span class="cm-attribute">room</span>=<span class="cm-string">"{Room ID}"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">本站当前在线人数 <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">span</span> <span class="cm-attribute">style</span>=<span class="cm-string">"color: red;"</span> <span class="cm-attribute">id</span>=<span class="cm-string">"online_user"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">span</span><span class="cm-tag cm-bracket">&gt;</span> 人</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">全站在线总时间 <span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">span</span> <span class="cm-attribute">style</span>=<span class="cm-string">"color: red;"</span> <span class="cm-attribute">id</span>=<span class="cm-string">"online_me"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">span</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">你的在线总时间: &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">span</span> <span class="cm-attribute">style</span>=<span class="cm-string">"color: red;"</span> <span class="cm-attribute">id</span>=<span class="cm-string">"online_total"</span><span class="cm-tag cm-bracket">&gt;&lt;/</span><span class="cm-tag">span</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 176px;"></div><div class="CodeMirror-gutters" style="display: none; height: 176px;"></div></div></div></pre>
        <center>
          <iframe
            frameborder="0"
            height="50px"
            marginwidth="0"
            scrolling="no"
            src="https://time-counter.onmicrosoft.cn/room/info"
          ></iframe>
        </center>
        <blockquote><center>Powered by: 🚀 Gin + Redis ✨</center></blockquote>

        <script src="https://giscus.onmicrosoft.cn/client.js"
        data-repo="zkeq/busuanzi"
        data-repo-id="R_kgDOHKdBPg"
        data-category="Announcements"
        data-category-id="DIC_kwDOHKdBPs4COh7s"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
    </script>

      </div>
    </div>
  </body>

  <script>
    let room = localStorage.getItem("room") || "info";
    let roomInput = document.getElementById("room-input");

    // getOnlineUser();
    roomInput.addEventListener("change", function (e) {
      if (e.target.value === "") {
        e.target.value = "info";
      }

      localStorage.setItem("room", e.target.value);
      room = e.target.value;
      document.getElementById("online_id").innerHTML = e.target.value;
      getOnlineUser();
    });

    function getOnlineUser() {
      // 移除之前的 online-counter
      let oldScript = document.getElementById("online-counter");
      if (oldScript) {
        oldScript.remove();
      }

      //create script
      let script = document.createElement("script");
      script.src = "https://time-counter.onmicrosoft.cn/counter.js";
      script.async = true;
      script.id = "online-counter";
      script.setAttribute("interval", 500);
      script.setAttribute("api", "https://time-counter.onmicrosoft.cn/counter");
      script.setAttribute("room", room);
      document.head.appendChild(script);
    }
  </script>
</html>
